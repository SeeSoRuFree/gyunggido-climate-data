<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ê¸°ë„ AI í•´ì»¤í†¤ ì¶œì„ ì²´í¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0A0E1A 0%, #1a2332 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(109, 181, 68, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(109, 181, 68, 0.3);
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #6DB544;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .scanner-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(109, 181, 68, 0.3);
        }

        #reader {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .status-message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
            display: block;
        }

        .status-message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
            display: block;
        }

        .status-message.duplicate {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #FF9800;
            color: #FF9800;
            display: block;
        }

        .recent-checkins {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(109, 181, 68, 0.2);
        }

        .recent-checkins h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #6DB544;
        }

        .checkin-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #6DB544;
        }

        .checkin-item:last-child {
            margin-bottom: 0;
        }

        .checkin-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .checkin-details {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .no-checkins {
            text-align: center;
            opacity: 0.5;
            padding: 20px;
        }

        .error-page {
            text-align: center;
            padding: 40px 20px;
        }

        .error-page h1 {
            color: #f44336;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .error-page p {
            opacity: 0.8;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .spinner {
            border: 3px solid rgba(109, 181, 68, 0.3);
            border-top: 3px solid #6DB544;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scan-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        #qr-shaded-region {
            border: 2px solid #6DB544 !important;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <header>
            <h1>ğŸ“‹ ê²½ê¸°ë„ AI í•´ì»¤í†¤ ì¶œì„ ì²´í¬</h1>
            <div class="subtitle">2025ë…„ 11ì›” 29ì¼ (í† )</div>
        </header>

        <div class="scanner-container">
            <div id="reader"></div>
            <div class="status-message" id="statusMessage"></div>
        </div>

        <div class="recent-checkins">
            <h2>ğŸ“Œ ìµœê·¼ ì²´í¬ì¸ ëª©ë¡</h2>
            <div id="recentList">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- html5-qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // âš ï¸ Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrE8z8gCVVj6p809mpjcbBFG4MRuhI1gQLxtoIX2_uGRnoFZ10GD344NQ5yTg6k4ozqg/exec';
        const VALID_TOKEN = 'HACKATHON2025SECRET';  // ë³´ì•ˆ í† í° (ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)

        // ìŠ¤ìº” ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
        let lastScannedCode = '';
        let lastScanTime = 0;
        let isProcessing = false;

        // URLì—ì„œ í† í° í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token !== VALID_TOKEN) {
            document.getElementById('app').innerHTML = `
                <div class="error-page">
                    <h1>ğŸš« ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h1>
                    <p>ìœ íš¨í•œ ì ‘ê·¼ ë§í¬ê°€ ì•„ë‹™ë‹ˆë‹¤.<br>ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>
                </div>
            `;
        } else {
            initializeScanner();
            loadRecentCheckIns();
            // 30ì´ˆë§ˆë‹¤ ìµœê·¼ ëª©ë¡ ìë™ ê°±ì‹ 
            setInterval(loadRecentCheckIns, 30000);
        }

        // QR ìŠ¤ìºë„ˆ ì´ˆê¸°í™”
        function initializeScanner() {
            const html5QrCode = new Html5Qrcode("reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" },  // í›„ë©´ ì¹´ë©”ë¼ ì‚¬ìš©
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', err);
                showMessage('error', 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            });
        }

        // QR ìŠ¤ìº” ì„±ê³µ ì‹œ
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR ìŠ¤ìº” ê²°ê³¼:', decodedText);

            // ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€ (3ì´ˆ ì´ë‚´ ê°™ì€ ì½”ë“œ ë¬´ì‹œ)
            const now = Date.now();
            if (isProcessing || (decodedText === lastScannedCode && now - lastScanTime < 3000)) {
                return;
            }

            // HK2025ë¡œ ì‹œì‘í•˜ëŠ” QR ì½”ë“œë§Œ ì²˜ë¦¬
            if (!decodedText.startsWith('HK2025-')) {
                showMessage('error', 'ì˜¬ë°”ë¥¸ í•´ì»¤í†¤ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            lastScannedCode = decodedText;
            lastScanTime = now;
            isProcessing = true;

            checkInAttendee(decodedText);
        }

        // QR ìŠ¤ìº” ì‹¤íŒ¨ ì‹œ (ë¬´ì‹œ)
        function onScanFailure(error) {
            // ìŠ¤ìº” ì¤‘ì—ëŠ” ê³„ì† ì—ëŸ¬ê°€ ë°œìƒí•˜ë¯€ë¡œ ë¬´ì‹œ
        }

        // ì¶œì„ ì²´í¬ì¸ ì²˜ë¦¬
        async function checkInAttendee(uniqueId) {
            try {
                const url = `${SCRIPT_URL}?action=checkIn&id=${encodeURIComponent(uniqueId)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    showMessage('success', `âœ… ${data.name}ë‹˜ ì²´í¬ì¸ ì™„ë£Œ!\n${data.track} | ${data.checkInTime}`);
                    loadRecentCheckIns();  // ìµœê·¼ ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
                } else if (data.status === 'duplicate') {
                    showMessage('duplicate', `âš ï¸ ${data.message}\nì²´í¬ì¸ ì‹œê°„: ${data.checkInTime}`);
                } else {
                    showMessage('error', `âŒ ${data.message}`);
                }
            } catch (error) {
                console.error('ì²´í¬ì¸ ì˜¤ë¥˜:', error);
                showMessage('error', 'âŒ ì²´í¬ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // 3ì´ˆ í›„ ë‹¤ì‹œ ìŠ¤ìº” ê°€ëŠ¥í•˜ë„ë¡
                setTimeout(() => {
                    isProcessing = false;
                }, 3000);
            }
        }

        // ìµœê·¼ ì²´í¬ì¸ ëª©ë¡ ë¡œë“œ
        async function loadRecentCheckIns() {
            try {
                const url = `${SCRIPT_URL}?action=getRecent`;
                const response = await fetch(url);
                const data = await response.json();

                const listContainer = document.getElementById('recentList');

                if (data.status === 'success' && data.recent.length > 0) {
                    listContainer.innerHTML = data.recent.map(item => `
                        <div class="checkin-item">
                            <div class="checkin-name">${item.name}</div>
                            <div class="checkin-details">${item.track} â€¢ ${item.checkInTime}</div>
                        </div>
                    `).join('');
                } else {
                    listContainer.innerHTML = '<div class="no-checkins">ì•„ì§ ì²´í¬ì¸í•œ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('recentList').innerHTML =
                    '<div class="no-checkins">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(type, message) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.className = `status-message ${type}`;
            messageEl.innerHTML = message.replace(/\n/g, '<br>');
            messageEl.style.display = 'block';  // ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œ

            // 5ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
